/**
 * ═══════════════════════════════════════════════════════════════════════════
 * EUREKA PANEL - Resposta Automatizada (Adaptive Immunity Fase 3-5)
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * EUREKA = CÉLULAS T EFETORAS do Active Immune System
 * Biologia: Células T eliminam células infectadas com precisão cirúrgica
 * Digital: Recebe APVs do Oráculo, gera contramedidas, valida e auto-remedeia
 *
 * FASES:
 * 3. FORMULAÇÃO RESPOSTA: Confirma vuln (ast-grep), gera patch (LLM/upgrade)
 * 4. CRISOL WARGAMING: Provisiona staging, testa regressão, simula ataque
 * 5. INTERFACE HITL: Pull Request automatizado com validação completa
 *
 * MÉTRICAS:
 * - Taxa Auto-Remediação: 70%+ target
 * - Patch Validation Rate: 100% (two-phase attack simulation)
 * - Regression Test Pass Rate: >95%
 * - Mean Time To PR: <15min
 */

import React, { useState, useEffect, useCallback } from 'react';
import logger from '@/utils/logger';
import './Panels.css';

export const EurekaPanel = ({ aiStatus, setAiStatus }) => {
  // === STATE MANAGEMENT ===
  const [viewMode, setViewMode] = useState('dashboard'); // dashboard | pending | history | wargaming
  const [stats, setStats] = useState({
    totalRemediations: 0,
    successfulPatches: 0,
    prsGenerated: 0,
    avgTimeToRemedy: 0,
    autoRemediationRate: 0,
    regressionTestPassRate: 0,
    patchValidationRate: 0,
    lastRemediationTime: null
  });
  const [pendingApvs, setPendingApvs] = useState([]);
  const [remediationHistory, setRemediationHistory] = useState([]);
  const [selectedApv, setSelectedApv] = useState(null);
  const [isRemediating, setIsRemediating] = useState(false);
  const [wargamingResults, setWargamingResults] = useState(null);

  // === DATA FETCHING ===
  const fetchStats = useCallback(async () => {
    try {
      const response = await fetch('http://localhost:8024/api/v1/eureka/stats');
      if (response.ok) {
        const data = await response.json();
        if (data.status === 'success') {
          setStats(data.data);
        }
      }
    } catch (error) {
      logger.error('Failed to fetch Eureka stats:', error);
    }
  }, []);

  const fetchPendingApvs = useCallback(async () => {
    try {
      const response = await fetch('http://localhost:8024/api/v1/eureka/pending-apvs');
      if (response.ok) {
        const data = await response.json();
        if (data.status === 'success') {
          setPendingApvs(data.data.apvs || []);
        }
      }
    } catch (error) {
      logger.error('Failed to fetch pending APVs:', error);
    }
  }, []);

  const fetchRemediationHistory = useCallback(async () => {
    try {
      const response = await fetch('http://localhost:8024/api/v1/eureka/history?limit=20');
      if (response.ok) {
        const data = await response.json();
        if (data.status === 'success') {
          setRemediationHistory(data.data.history || []);
        }
      }
    } catch (error) {
      logger.error('Failed to fetch remediation history:', error);
    }
  }, []);

  useEffect(() => {
    fetchStats();
    fetchPendingApvs();
    fetchRemediationHistory();
    
    const statsInterval = setInterval(fetchStats, 10000);
    const apvsInterval = setInterval(fetchPendingApvs, 15000);
    const historyInterval = setInterval(fetchRemediationHistory, 30000);

    return () => {
      clearInterval(statsInterval);
      clearInterval(apvsInterval);
      clearInterval(historyInterval);
    };
  }, [fetchStats, fetchPendingApvs, fetchRemediationHistory]);

  // === ACTIONS ===
  const triggerAutoRemediation = async (apvId) => {
    setIsRemediating(true);
    setAiStatus(prev => ({
      ...prev,
      eureka: { ...prev.eureka, status: 'running' }
    }));

    try {
      const response = await fetch(`http://localhost:8024/api/v1/eureka/remediate/${apvId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mode: 'auto',
          runWargaming: true,
          generatePR: true
        })
      });

      if (response.ok) {
        const result = await response.json();
        if (result.status === 'success') {
          logger.info('Auto-remediation completed:', result.data);
          setWargamingResults(result.data.wargaming_results);
          await fetchStats();
          await fetchPendingApvs();
          await fetchRemediationHistory();
        }
      } else {
        logger.error('Remediation failed:', await response.text());
      }
    } catch (error) {
      logger.error('Error during remediation:', error);
    } finally {
      setIsRemediating(false);
      setAiStatus(prev => ({
        ...prev,
        eureka: { ...prev.eureka, status: 'idle', lastRun: new Date().toLocaleTimeString() }
      }));
    }
  };

  const viewApvDetails = (apv) => {
    setSelectedApv(apv);
  };

  // === UTILITY FUNCTIONS ===
  const getSeverityColor = (severity) => {
    switch (severity?.toUpperCase()) {
      case 'CRITICAL': return 'severity-critical';
      case 'HIGH': return 'severity-high';
      case 'MEDIUM': return 'severity-medium';
      case 'LOW': return 'severity-low';
      default: return 'severity-info';
    }
  };

  const getRemediationStatusColor = (status) => {
    switch (status) {
      case 'success': return 'text-green-400';
      case 'pending': return 'text-yellow-400';
      case 'failed': return 'text-red-400';
      case 'in_progress': return 'text-blue-400';
      default: return 'text-gray-400';
    }
  };

  const formatTimestamp = (timestamp) => {
    if (!timestamp) return 'N/A';
    const date = new Date(timestamp);
    return date.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  return (
    <div className="eureka-panel">
      {/* ═══════════════════════════════════════════════════════════════ */}
      {/* TOP SECTION - Stats */}
      {/* ═══════════════════════════════════════════════════════════════ */}
      <div className="panel-top">
        <div className="stats-grid">
          <div className="stat-card stat-primary">
            <div className="stat-icon">🔬</div>
            <div className="stat-content">
              <div className="stat-label">Análises Realizadas</div>
              <div className="stat-value">{stats.totalAnalyses || 0}</div>
            </div>
          </div>

          <div className="stat-card stat-danger">
            <div className="stat-icon">⚠️</div>
            <div className="stat-content">
              <div className="stat-label">Ameaças Detectadas</div>
              <div className="stat-value">{stats.threatsDetected || 0}</div>
            </div>
          </div>

          <div className="stat-card stat-info">
            <div className="stat-icon">📋</div>
            <div className="stat-content">
              <div className="stat-label">Playbooks Gerados</div>
              <div className="stat-value">{stats.playbooksGenerated || 0}</div>
            </div>
          </div>

          <div className="stat-card stat-warning">
            <div className="stat-icon">📊</div>
            <div className="stat-content">
              <div className="stat-label">Score Médio de Ameaça</div>
              <div className="stat-value">{stats.avgThreatScore || 0}</div>
            </div>
          </div>
        </div>
      </div>

      {/* ═══════════════════════════════════════════════════════════════ */}
      {/* MODE TOGGLE */}
      {/* ═══════════════════════════════════════════════════════════════ */}
      <div className="mode-toggle">
        <button
          className={`mode-btn ${analysisMode === 'upload' ? 'mode-btn-active' : ''}`}
          onClick={() => setAnalysisMode('upload')}
        >
          📤 Nova Análise
        </button>
        <button
          className={`mode-btn ${analysisMode === 'results' ? 'mode-btn-active' : ''}`}
          onClick={() => setAnalysisMode('results')}
          disabled={!analysisResult}
        >
          📊 Resultados
        </button>
      </div>

      {/* ═══════════════════════════════════════════════════════════════ */}
      {/* UPLOAD MODE */}
      {/* ═══════════════════════════════════════════════════════════════ */}
      {analysisMode === 'upload' && (
        <div className="upload-section">
          <div className="upload-card">
            <div className="upload-header">
              <h3>🔬 Análise Profunda de Malware</h3>
              <p>Especifique o caminho do arquivo suspeito para análise completa</p>
            </div>

            <div className="upload-form">
              <div className="form-group-full">
                <label htmlFor="input-caminho-do-arquivo-ajeqz">Caminho do Arquivo</label>
<input id="input-caminho-do-arquivo-ajeqz"
                  type="text"
                  value={filePath}
                  onChange={(e) => setFilePath(e.target.value)}
                  placeholder="/path/to/suspicious/file.exe"
                  className="form-input"
                />
                <small className="form-hint">
                  💡 Exemplo: /tmp/malware_sample.bin ou /home/user/suspicious.exe
                </small>
              </div>

              <div className="form-group-checkbox">
                <label className="checkbox-label">
                  <input
                    type="checkbox"
                    checked={generatePlaybook}
                    onChange={(e) => setGeneratePlaybook(e.target.checked)}
                  />
                  <span>Gerar Playbook de Resposta Automática (ADR-compatible)</span>
                </label>
              </div>

              <button
                onClick={analyzeFile}
                disabled={isAnalyzing || !filePath.trim()}
                className={`btn-analyze ${isAnalyzing ? 'btn-analyzing' : ''}`}
              >
                {isAnalyzing ? (
                  <>
                    <span className="spinner"></span>
                    <span>Analisando Arquivo...</span>
                  </>
                ) : (
                  <>
                    <span>🚀</span>
                    <span>Iniciar Análise EUREKA</span>
                  </>
                )}
              </button>
            </div>

            {/* Analysis Pipeline Info */}
            <div className="pipeline-info">
              <h4>🔄 Pipeline de Análise:</h4>
              <ol className="pipeline-steps">
                <li>🔍 <strong>Pattern Detection:</strong> Escaneamento de 40+ padrões maliciosos</li>
                <li>🌐 <strong>IOC Extraction:</strong> Extração de IPs, domains, hashes, CVEs, etc.</li>
                <li>🎯 <strong>Classification:</strong> Identificação de família e tipo de malware</li>
                <li>⚠️ <strong>Threat Scoring:</strong> Cálculo de score de ameaça (0-100)</li>
                <li>📋 <strong>Playbook Generation:</strong> Geração de resposta automatizada</li>
                <li>📊 <strong>Report:</strong> Relatório completo com evidências</li>
              </ol>
            </div>

            {/* Detected Patterns Info */}
            {patterns && patterns.total_patterns > 0 && (
              <div className="patterns-info">
                <h4>🎯 Padrões Disponíveis ({patterns.total_patterns}):</h4>
                <div className="patterns-grid">
                  {Object.entries(patterns.by_category || {}).map(([category, count]) => (
                    <div key={category} className="pattern-badge">
                      <span className="pattern-name">{category}</span>
                      <span className="pattern-count">{count}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ═══════════════════════════════════════════════════════════════ */}
      {/* RESULTS MODE */}
      {/* ═══════════════════════════════════════════════════════════════ */}
      {analysisMode === 'results' && analysisResult && (
        <div className="results-section">
          {/* Classification & Threat Score */}
          <div className="results-header-card">
            <div className="classification-info">
              <h3>🦠 Classificação do Malware</h3>
              <div className="classification-details">
                <div className="detail-item">
                  <span className="detail-label">Família:</span>
                  <span className="detail-value family-tag">{analysisResult.classification.family || 'Unknown'}</span>
                </div>
                <div className="detail-item">
                  <span className="detail-label">Tipo:</span>
                  <span className="detail-value type-tag">{analysisResult.classification.type || 'Unknown'}</span>
                </div>
                <div className="detail-item">
                  <span className="detail-label">Severidade:</span>
                  <span className={`detail-value severity-badge ${getSeverityColor(analysisResult.severity)}`}>
                    {analysisResult.severity || 'UNKNOWN'}
                  </span>
                </div>
              </div>
            </div>

            <div className="threat-score-display">
              <div className="score-label">THREAT SCORE</div>
              <div className={`score-value ${getThreatScoreColor(analysisResult.threat_score)}`}>
                {analysisResult.threat_score}
                <span className="score-max">/100</span>
              </div>
              <div className="score-bar">
                <div
                  className={`score-fill ${getThreatScoreColor(analysisResult.threat_score)}`}
                  style={{ width: `${analysisResult.threat_score}%` }}
                ></div>
              </div>
            </div>
          </div>

          {/* Malicious Patterns Detected */}
          {analysisResult.patterns_detected && analysisResult.patterns_detected.length > 0 && (
            <div className="patterns-detected-card">
              <h3>🎯 Padrões Maliciosos Detectados ({analysisResult.patterns_detected.length})</h3>
              <div className="patterns-list">
                {analysisResult.patterns_detected.map((pattern, index) => (
                  <div key={index} className={`pattern-item ${getSeverityColor(pattern.severity)}`}>
                    <div className="pattern-header">
                      <span className="pattern-name">{pattern.name}</span>
                      <span className={`pattern-severity ${getSeverityColor(pattern.severity)}`}>
                        {pattern.severity}
                      </span>
                    </div>
                    <div className="pattern-details">
                      <span className="pattern-category">📂 {pattern.category}</span>
                      <span className="pattern-confidence">🎯 Confiança: {(pattern.confidence * 100).toFixed(0)}%</span>
                      {pattern.mitre_technique && (
                        <span className="pattern-mitre">🔗 MITRE: {pattern.mitre_technique}</span>
                      )}
                    </div>
                    {pattern.matched_content && (
                      <div className="pattern-match">
                        <code>{pattern.matched_content.substring(0, 100)}...</code>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* IOCs Extracted */}
          {analysisResult.iocs && analysisResult.iocs.length > 0 && (
            <div className="iocs-card">
              <h3>🌐 Indicadores de Comprometimento (IOCs) - {analysisResult.iocs.length} encontrados</h3>
              <div className="iocs-grid">
                {analysisResult.iocs.map((ioc, index) => (
                  <div key={index} className="ioc-item">
                    <div className="ioc-type">{ioc.ioc_type}</div>
                    <div className="ioc-value">{ioc.value}</div>
                    <div className="ioc-confidence">
                      Confiança: {(ioc.confidence * 100).toFixed(0)}%
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Playbook Generated */}
          {analysisResult.response_playbook && (
            <div className="playbook-card">
              <h3>📋 Playbook de Resposta Gerado</h3>
              <div className="playbook-info">
                <div className="playbook-header">
                  <span className="playbook-name">{analysisResult.response_playbook.name}</span>
                  <span className="playbook-priority">{analysisResult.response_playbook.priority}</span>
                </div>
                <p className="playbook-description">{analysisResult.response_playbook.description}</p>

                <div className="playbook-actions">
                  <h4>Ações Automáticas ({analysisResult.response_playbook.actions?.length || 0}):</h4>
                  <div className="actions-list">
                    {analysisResult.response_playbook.actions?.map((action, index) => (
                      <div key={index} className="action-item">
                        <span className="action-type">{action.type}</span>
                        <span className="action-desc">{action.description || action.action}</span>
                        {action.requires_approval && (
                          <span className="action-approval">⚠️ Requer Aprovação</span>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="playbook-mitre">
                  <strong>MITRE ATT&CK:</strong>
                  {analysisResult.response_playbook.mitre_techniques?.map((tech, i) => (
                    <span key={i} className="mitre-tag">{tech}</span>
                  ))}
                </div>
              </div>

              <button className="btn-execute-playbook">
                🚀 Enviar para ADR Core (Executar Resposta)
              </button>
            </div>
          )}

          {/* File Hashes */}
          {analysisResult.file_hashes && (
            <div className="hashes-card">
              <h3>🔐 Hashes do Arquivo</h3>
              <div className="hashes-list">
                <div className="hash-item">
                  <span className="hash-label">MD5:</span>
                  <code className="hash-value">{analysisResult.file_hashes.md5}</code>
                </div>
                <div className="hash-item">
                  <span className="hash-label">SHA1:</span>
                  <code className="hash-value">{analysisResult.file_hashes.sha1}</code>
                </div>
                <div className="hash-item">
                  <span className="hash-label">SHA256:</span>
                  <code className="hash-value">{analysisResult.file_hashes.sha256}</code>
                </div>
              </div>
            </div>
          )}

          {/* Action Buttons */}
          <div className="results-actions">
            <button
              onClick={() => {
                setAnalysisMode('upload');
                setAnalysisResult(null);
                setFilePath('');
              }}
              className="btn-new-analysis"
            >
              🔬 Nova Análise
            </button>
            <button className="btn-export-report">
              📄 Exportar Relatório
            </button>
            <button className="btn-share-threat-intel">
              🌐 Compartilhar com Threat Intel
            </button>
          </div>
        </div>
      )}

      {/* Empty State */}
      {analysisMode === 'results' && !analysisResult && (
        <div className="results-empty">
          <div className="empty-icon">🔬</div>
          <h3>Nenhuma análise realizada ainda</h3>
          <p>Execute uma análise para visualizar os resultados</p>
          <button
            onClick={() => setAnalysisMode('upload')}
            className="btn-start-analysis"
          >
            Iniciar Primeira Análise
          </button>
        </div>
      )}
    </div>
  );
};

export default EurekaPanel;
