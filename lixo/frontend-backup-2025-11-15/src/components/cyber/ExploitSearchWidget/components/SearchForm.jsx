/**
 * CVE SEARCH FORM - Semantic Form for Exploit Search
 *
 * AI-FIRST DESIGN (Maximus Vision Protocol):
 * - <form> with role="search"
 * - <label> associated with input
 * - aria-describedby for hint and error
 * - aria-live for loading status
 *
 * WCAG 2.1 AAA Compliance:
 * - Labeled form controls
 * - Error messages associated
 * - Loading status announced
 * - Keyboard accessible
 *
 * SECURITY (Boris Cherny Standard):
 * - GAP #14 FIXED: CVE validation
 * - maxLength on all inputs
 * - Sanitization of user input
 *
 * @version 3.0.0 (Security Hardened)
 * @see MAXIMUS_VISION_PROTOCOL_HTML_BLUEPRINT.md
 */

import React, { useState } from 'react';
import { Button } from '../../../shared/Button';
import { Input } from '../../../shared/Input';
import { validateCVE } from '../../../../utils/validation';
import { sanitizePlainText } from '../../../../utils/sanitization';
import styles from './SearchForm.module.css';

export const SearchForm = ({ onSearch, loading, error }) => {
  const [cveId, setCveId] = useState('');
  const [validationError, setValidationError] = useState(null);

  // Secure CVE input handler
  const handleCveIdChange = (e) => {
    const sanitized = sanitizePlainText(e.target.value);
    setCveId(sanitized);
    if (validationError) setValidationError(null);
  };

  // Validate CVE on blur
  const handleCveIdBlur = () => {
    if (!cveId.trim()) {
      return;
    }

    const result = validateCVE(cveId);
    if (!result.valid) {
      setValidationError(result.error);
    } else {
      setValidationError(null);
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();

    // Validate before submission
    if (!cveId.trim()) {
      setValidationError('CVE ID is required');
      return;
    }

    const result = validateCVE(cveId);
    if (!result.valid) {
      setValidationError(result.error);
      return;
    }

    // Only proceed if no errors
    if (!validationError && !loading) {
      onSearch(cveId);
    }
  };

  return (
    <div className={styles.searchSection}>
      <form
        onSubmit={handleSubmit}
        className={styles.searchForm}
        role="search"
        aria-label="CVE exploit search">

        <label htmlFor="cve-id-input" className={styles.visuallyHidden}>
          CVE ID
        </label>
        <Input
          id="cve-id-input"
          type="text"
          placeholder="CVE-2024-1234"
          value={cveId}
          onChange={handleCveIdChange}
          onBlur={handleCveIdBlur}
          disabled={loading}
          variant="cyber"
          size="lg"
          icon={<i className="fas fa-bug" aria-hidden="true"></i>}
          error={error}
          maxLength={50}
          aria-describedby={validationError ? "validation-error" : "cve-search-hint"}
          aria-invalid={!!validationError}
        />
        {validationError && (
          <div
            id="validation-error"
            className={styles.error}
            role="alert"
            aria-live="polite"
          >
            {validationError}
          </div>
        )}
        <Button
          type="submit"
          variant="primary"
          size="lg"
          loading={loading}
          disabled={!cveId.trim()}
          icon={loading ? null : <i className="fas fa-search" aria-hidden="true"></i>}
          aria-label="Search for CVE exploits">
          {loading ? 'BUSCANDO...' : 'BUSCAR'}
        </Button>
      </form>

      <p id="cve-search-hint" className={styles.hint}>
        <i className="fas fa-info-circle" aria-hidden="true"></i>
        Busca em 40K+ exploits (Exploit-DB, Metasploit, NVD)
      </p>

      {error && (
        <div id="cve-search-error" className={styles.error} role="alert">
          {error}
        </div>
      )}

      {loading && (
        <div className={styles.visuallyHidden} role="status" aria-live="polite">
          Searching for CVE exploits...
        </div>
      )}
    </div>
  );
};

export default SearchForm;
