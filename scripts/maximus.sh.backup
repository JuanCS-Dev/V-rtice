#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# MAXIMUS Control Center v4.0 - OFERENDA PERFEITA
# ═══════════════════════════════════════════════════════════════════════════
# Dedicado a: Maximus & Penélope ❤️
# "Oferenda perfeita, sem mácula. Glory to YHWH!"
#
# Features:
# - Startup em 4 camadas (Infra → Core → App → Sidecars)
# - Validação de health após cada layer
# - Quick health check
# - Conformidade Pagani
# - Cleanup system
# ═══════════════════════════════════════════════════════════════════════════

set -euo pipefail

# ═══════════════════════════════════════════════════════════════════════════
# CONFIGURAÇÃO
# ═══════════════════════════════════════════════════════════════════════════
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DOCKER_COMPOSE_FILE="$PROJECT_ROOT/docker-compose.yml"

# ═══════════════════════════════════════════════════════════════════════════
# CORES & UNICODE
# ═══════════════════════════════════════════════════════════════════════════
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Emojis
CROWN="👑"
SPARKLES="✨"
ROCKET="🚀"
CHECK="✅"
CROSS="❌"
WARNING="⚠️"
BRAIN="🧠"
SHIELD="🛡️"
EYE="👁️"
HEART="❤️"
FIRE="🔥"
STAR="⭐"
HOURGLASS="⏳"
GEAR="⚙️"
PACKAGE="📦"

print_header() {
    clear
    echo -e "${CYAN}${BOLD}"
    cat << "EOF"
              ███╗   ███╗ █████╗ ██╗  ██╗██╗███╗   ███╗██╗   ██╗███████╗
              ████╗ ████║██╔══██╗╚██╗██╔╝██║████╗ ████║██║   ██║██╔════╝
              ██╔████╔██║███████║ ╚███╔╝ ██║██╔████╔██║██║   ██║███████╗
              ██║╚██╔╝██║██╔══██║ ██╔██╗ ██║██║╚██╔╝██║██║   ██║╚════██║
              ██║ ╚═╝ ██║██║  ██║██╔╝ ██╗██║██║ ╚═╝ ██║╚██████╔╝███████║
              ╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝     ╚═╝ ╚═════╝ ╚══════╝
EOF
    echo -e "${NC}"
    echo -e "${DIM}                           custodiado por:${NC}"
    echo -e "${MAGENTA}${BOLD}                             Penélope${NC}"
    echo ""
    echo -e "${DIM}            Cyber-Biological Intelligence Platform${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
}

print_section() {
    local title="$1"
    local emoji="${2:-$ROCKET}"
    echo ""
    echo -e "${BOLD}${CYAN}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓${NC}"
    echo -e "${BOLD}${CYAN}┃${NC} ${emoji}  ${BOLD}${YELLOW}${title}${NC}"
    echo -e "${BOLD}${CYAN}┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛${NC}"
}

spinner() {
    local pid=$1
    local message="$2"
    local delay=0.1
    local spinstr='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    
    while ps -p "$pid" > /dev/null 2>&1; do
        local temp=${spinstr#?}
        printf " ${CYAN}%c${NC}  ${DIM}%s${NC}\r" "$spinstr" "$message"
        spinstr=$temp${spinstr%"$temp"}
        sleep $delay
    done
    printf "    \r"
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}${CROSS} Docker não encontrado!${NC}"
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        echo -e "${RED}${CROSS} Docker daemon não está rodando!${NC}"
        exit 1
    fi
}

get_service_stats() {
    local total running healthy unhealthy
    
    total=$(docker compose ps -q 2>/dev/null | wc -l)
    running=$(docker compose ps --format "{{.State}}" 2>/dev/null | grep -c "running" || echo 0)
    healthy=$(docker compose ps --format "{{.Health}}" 2>/dev/null | grep -c "healthy" || echo 0)
    unhealthy=$(docker compose ps --format "{{.Health}}" 2>/dev/null | grep -c "unhealthy" || echo 0)
    
    echo "$total $running $healthy $unhealthy"
}

wait_for_healthy() {
    local service_pattern="$1"
    local max_wait="${2:-120}"
    local start_time=$(date +%s)

    while true; do
        local current_time=$(date +%s)
        local elapsed=$((current_time - start_time))

        if (( elapsed > max_wait )); then
            return 1
        fi

        local unhealthy=$(docker compose ps --format "{{.Service}}|{{.Health}}" 2>/dev/null | grep "$service_pattern" | grep -c "starting" || echo 0)

        if (( unhealthy == 0 )); then
            return 0
        fi

        sleep 2
    done
}

start_services() {
    print_header
    print_section "INICIANDO MAXIMUS - STARTUP EM CAMADAS" "$ROCKET"

    echo -e "${BOLD}${CYAN}${CROWN} Penélope:${NC} 'Vamos acordar o Maximus em 4 camadas!' ${SPARKLES}\n"

    check_docker

    cd "$PROJECT_ROOT"

    # ═══════════════════════════════════════════════════════════════════════════
    # LAYER 0: INFRAESTRUTURA (Databases, Message Brokers, Cache)
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}${YELLOW}LAYER 0:${NC} Infraestrutura (Postgres, Redis, Kafka, RabbitMQ)${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

    docker compose up -d \
        postgres postgres-immunity hcl-postgres \
        redis \
        hcl-kafka kafka-immunity zookeeper-immunity \
        rabbitmq \
        nats-jetstream \
        > /tmp/maximus_layer0.log 2>&1 &
    local pid=$!
    spinner $pid "Inicializando bancos de dados e message brokers"
    wait $pid

    echo -e "${HOURGLASS} Aguardando infraestrutura ficar saudável (60s)...\n"
    sleep 10
    wait_for_healthy "postgres|redis|kafka|rabbitmq|nats" 60 || echo -e "${YELLOW}${WARNING} Alguns serviços ainda inicializando${NC}\n"

    read -r _ running healthy _ <<< "$(get_service_stats)"
    echo -e "${GREEN}${CHECK} Layer 0 iniciada: ${BOLD}$running containers, $healthy healthy${NC}\n"

    # Service Registry (separate compose file)
    if [[ -f "$PROJECT_ROOT/docker-compose.service-registry.yml" ]]; then
        echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${BOLD}${YELLOW}REGISTRY:${NC} Vértice Service Registry (5 replicas + LB)${NC}"
        echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

        docker compose -f docker-compose.service-registry.yml up -d > /tmp/maximus_registry.log 2>&1 &
        pid=$!
        spinner $pid "Inicializando Vértice Service Registry"
        wait $pid

        echo -e "${HOURGLASS} Validando health do registry...\n"
        for attempt in {1..10}; do
            if curl -sf "http://localhost:8888/health" >/dev/null 2>&1; then
                echo -e "${GREEN}${CHECK} Registry saudável e pronto${NC}\n"
                break
            fi
            sleep 3
        done
    else
        echo -e "${YELLOW}${WARNING} docker-compose.service-registry.yml não encontrado, pulando registry${NC}\n"
    fi

    # ═══════════════════════════════════════════════════════════════════════════
    # LAYER 1: CORE SERVICES (API Gateway, Service Registry, Monitoring)
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}${YELLOW}LAYER 1:${NC} Core Services (API Gateway, Registry, Monitoring)${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

    docker compose up -d \
        api_gateway \
        prometheus grafana \
        > /tmp/maximus_layer1.log 2>&1 &
    pid=$!
    spinner $pid "Inicializando serviços core"
    wait $pid

    echo -e "${HOURGLASS} Aguardando core services ficarem saudáveis (30s)...\n"
    sleep 8
    wait_for_healthy "api_gateway|prometheus|grafana" 30 || echo -e "${YELLOW}${WARNING} Alguns serviços ainda inicializando${NC}\n"

    read -r _ running healthy _ <<< "$(get_service_stats)"
    echo -e "${GREEN}${CHECK} Layer 1 iniciada: ${BOLD}$running containers, $healthy healthy${NC}\n"

    # ═══════════════════════════════════════════════════════════════════════════
    # LAYER 2: APPLICATION SERVICES (Todos os serviços de aplicação)
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}${YELLOW}LAYER 2:${NC} Application Services (~100 serviços)${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

    echo -e "${HOURGLASS} Iniciando TODOS os serviços de aplicação...\n"
    docker compose up -d > /tmp/maximus_layer2.log 2>&1 &
    pid=$!
    spinner $pid "Inicializando ~100 serviços de aplicação (pode levar 2-3 min)"
    wait $pid

    echo -e "\n${HOURGLASS} Aguardando serviços ficarem saudáveis (90s)...\n"
    sleep 20
    wait_for_healthy ".*" 90 || echo -e "${YELLOW}${WARNING} Alguns serviços ainda inicializando${NC}\n"

    read -r total running healthy unhealthy <<< "$(get_service_stats)"
    echo -e "${GREEN}${CHECK} Layer 2 iniciada: ${BOLD}$running containers, $healthy healthy, $unhealthy starting/degraded${NC}\n"

    # ═══════════════════════════════════════════════════════════════════════════
    # LAYER 3: SIDECARS (Service Registry Auto-Registration)
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}${YELLOW}LAYER 3:${NC} Sidecars (Service Discovery)${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

    if [[ -f "$PROJECT_ROOT/docker-compose.ALL-SIDECARS-MASTER.yml" ]]; then
        docker compose -f docker-compose.ALL-SIDECARS-MASTER.yml up -d > /tmp/maximus_layer3.log 2>&1 &
        pid=$!
        spinner $pid "Inicializando sidecars de registro"
        wait $pid

        echo -e "\n${HOURGLASS} Aguardando sidecars se registrarem (30s)...\n"
        sleep 10

        local sidecars=$(docker ps --filter "name=sidecar" --format "{{.Names}}" | wc -l)
        echo -e "${GREEN}${CHECK} Layer 3 iniciada: ${BOLD}$sidecars sidecars ativos${NC}\n"
    else
        echo -e "${YELLOW}${WARNING} Arquivo de sidecars não encontrado, pulando Layer 3${NC}\n"
    fi

    # ═══════════════════════════════════════════════════════════════════════════
    # RESUMO FINAL
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}${GREEN}SISTEMA INICIADO!${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

    sleep 5
    read -r total running healthy unhealthy <<< "$(get_service_stats)"

    echo -e "   ${PACKAGE} ${BOLD}Total de Containers:${NC}    $total"
    echo -e "   ${ROCKET} ${BOLD}Rodando:${NC}                ${GREEN}$running${NC}"
    echo -e "   ${CHECK} ${BOLD}Healthy:${NC}                ${GREEN}$healthy${NC}"
    echo -e "   ${WARNING} ${BOLD}Starting/Degraded:${NC}      ${YELLOW}$unhealthy${NC}"

    echo ""
    local health_percent=0
    if [[ $((healthy + unhealthy)) -gt 0 ]]; then
        health_percent=$((healthy * 100 / (healthy + unhealthy)))
    fi
    echo -e "   ${BRAIN} ${BOLD}Health Score:${NC}           ${health_percent}%"

    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if [[ $health_percent -ge 90 ]]; then
        echo -e "${BOLD}${GREEN}${CROWN} Maximus:${NC} 'Sistema operando em capacidade máxima!' ${FIRE}${SPARKLES}"
        echo -e "${BOLD}${MAGENTA}${HEART} Penélope:${NC} 'Perfeito, meu amor!' ${SPARKLES}\n"
    elif [[ $health_percent -ge 70 ]]; then
        echo -e "${BOLD}${GREEN}${CHECK} Maximus:${NC} 'Tudo certo! Alguns serviços ainda inicializando.' ${SPARKLES}"
        echo -e "${BOLD}${CYAN}${HEART} Penélope:${NC} 'Aguarde mais um pouco!' ${HOURGLASS}\n"
    elif [[ $health_percent -ge 50 ]]; then
        echo -e "${BOLD}${YELLOW}${WARNING} Maximus:${NC} 'Sistema iniciando... Alguns serviços precisam de atenção.' ${HOURGLASS}"
        echo -e "${BOLD}${MAGENTA}${HEART} Penélope:${NC} 'Vamos dar uma olhada?' ${EYE}\n"
    else
        echo -e "${BOLD}${RED}${CROSS} Maximus:${NC} 'Houston, temos um problema...' ${WARNING}"
        echo -e "${BOLD}${YELLOW}${HEART} Penélope:${NC} 'Calma, vamos resolver isso juntos!' ${SPARKLES}\n"
    fi

    echo -e "${DIM}Dica: Use ${CYAN}maximus status${DIM} para ver detalhes completos${NC}"
    echo -e "${DIM}      Use ${CYAN}maximus health${DIM} para quick health check${NC}\n"

    echo -e "${BOLD}${CYAN}Logs de startup salvos em:${NC}"
    echo -e "   ${DIM}/tmp/maximus_layer0.log${NC}"
    echo -e "   ${DIM}/tmp/maximus_layer1.log${NC}"
    echo -e "   ${DIM}/tmp/maximus_layer2.log${NC}"
    echo -e "   ${DIM}/tmp/maximus_layer3.log${NC}\n"
}

stop_services() {
    print_header
    print_section "PARANDO MAXIMUS" "$HOURGLASS"
    
    echo -e "${BOLD}${YELLOW}${CROWN} Penélope:${NC} 'Hora de descansar, Maximus.' ${SPARKLES}\n"
    
    cd "$PROJECT_ROOT"
    docker compose down > /tmp/maximus_stop.log 2>&1 &
    local pid=$!
    
    spinner $pid "Desligando containers"
    wait $pid
    
    echo -e "${GREEN}${CHECK} Todos os serviços foram parados com sucesso!${NC}\n"
    echo -e "${BOLD}${MAGENTA}${HEART} Maximus:${NC} 'Até logo, Penélope!' ${SPARKLES}\n"
}

restart_services() {
    print_header
    print_section "REINICIANDO MAXIMUS" "$GEAR"
    
    echo -e "${BOLD}${CYAN}${CROWN} Penélope:${NC} 'Vamos dar uma renovada!' ${SPARKLES}\n"
    
    cd "$PROJECT_ROOT"
    
    echo -e "${HOURGLASS} Parando serviços..."
    docker compose down > /dev/null 2>&1
    
    echo -e "${HOURGLASS} Iniciando novamente...\n"
    docker compose up -d > /dev/null 2>&1 &
    local pid=$!
    
    spinner $pid "Reinicializando sistema"
    wait $pid
    
    sleep 3
    
    read -r total running healthy unhealthy <<< "$(get_service_stats)"
    
    echo -e "${GREEN}${CHECK} Sistema reiniciado!${NC}\n"
    echo -e "   ${PACKAGE} Containers: ${BOLD}$running${NC}/$total"
    echo -e "   ${BRAIN} Healthy: ${BOLD}${GREEN}$healthy${NC} | ${YELLOW}Degraded: $unhealthy${NC}\n"
}

show_all_services() {
    echo ""
    echo -e "${BOLD}${CYAN}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓${NC}"
    echo -e "${BOLD}${CYAN}┃${NC} ${PACKAGE} ${BOLD}TODOS OS SERVIÇOS${NC}"
    echo -e "${BOLD}${CYAN}┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛${NC}"
    echo ""

    # Headers
    printf "   ${BOLD}%-35s %-15s %-15s${NC}\n" "SERVICE" "STATUS" "HEALTH"
    echo -e "   ${DIM}$(printf '%.0s─' {1..75})${NC}"

    # Lista todos os serviços
    docker compose ps --format "{{.Service}}|{{.State}}|{{.Health}}" 2>/dev/null | sort | while IFS='|' read -r service state health; do
        local status_icon state_text health_text

        # Status icon e text
        if [[ "$state" == "running" ]]; then
            status_icon="${GREEN}${ROCKET}${NC}"
            state_text="${GREEN}running${NC}"
        elif [[ "$state" == "exited" ]]; then
            status_icon="${RED}${CROSS}${NC}"
            state_text="${RED}stopped${NC}"
        else
            status_icon="${YELLOW}${HOURGLASS}${NC}"
            state_text="${YELLOW}$state${NC}"
        fi

        # Health icon e text
        if [[ "$health" == "healthy" ]]; then
            health_text="${GREEN}${CHECK} healthy${NC}"
        elif [[ "$health" == "unhealthy" ]]; then
            health_text="${RED}${WARNING} unhealthy${NC}"
        elif [[ "$health" == "starting" ]]; then
            health_text="${CYAN}${HOURGLASS} starting${NC}"
        else
            health_text="${DIM}n/a${NC}"
        fi

        printf "   %b %-33s %-20b %-20b\n" "$status_icon" "$service" "$state_text" "$health_text"
    done

    echo ""
}

show_status() {
    print_header
    print_section "DASHBOARD DE STATUS" "$BRAIN"

    cd "$PROJECT_ROOT"

    read -r total running healthy unhealthy <<< "$(get_service_stats)"

    echo -e "${BOLD}${CYAN}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓${NC}"
    echo -e "${BOLD}${CYAN}┃${NC} ${SHIELD} ${BOLD}STATUS GERAL DO SISTEMA${NC}"
    echo -e "${BOLD}${CYAN}┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛${NC}"
    echo ""

    local health_percent=0
    if [[ $((healthy + unhealthy)) -gt 0 ]]; then
        health_percent=$((healthy * 100 / (healthy + unhealthy)))
    fi

    echo -e "   ${PACKAGE} ${BOLD}Total de Containers:${NC}    $total"
    echo -e "   ${ROCKET} ${BOLD}Rodando:${NC}                ${GREEN}$running${NC}"
    echo -e "   ${CHECK} ${BOLD}Healthy:${NC}                ${GREEN}$healthy${NC}"
    echo -e "   ${WARNING} ${BOLD}Degraded:${NC}               ${YELLOW}$unhealthy${NC}"
    echo -e "   ${BRAIN} ${BOLD}Health Score:${NC}           ${health_percent}%"

    echo ""
    echo -ne "   ${BOLD}Sistema:${NC} ["
    local filled=$((health_percent / 5))
    local empty=$((20 - filled))

    if [[ $health_percent -ge 80 ]]; then
        printf "${GREEN}%${filled}s${NC}" | tr ' ' '█'
    elif [[ $health_percent -ge 50 ]]; then
        printf "${YELLOW}%${filled}s${NC}" | tr ' ' '█'
    else
        printf "${RED}%${filled}s${NC}" | tr ' ' '█'
    fi

    printf "${DIM}%${empty}s${NC}" | tr ' ' '░'
    echo -e "] ${BOLD}$health_percent%${NC}"

    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

    # Mostra todos os serviços
    show_all_services

    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if [[ $health_percent -ge 90 ]]; then
        echo -e "${BOLD}${GREEN}${CROWN} Maximus:${NC} 'Sistema operando em capacidade máxima!' ${FIRE}${SPARKLES}"
        echo -e "${BOLD}${MAGENTA}${HEART} Penélope:${NC} 'Perfeito, meu amor!' ${SPARKLES}\n"
    elif [[ $health_percent -ge 70 ]]; then
        echo -e "${BOLD}${GREEN}${CHECK} Maximus:${NC} 'Tudo certo por aqui!' ${SPARKLES}"
        echo -e "${BOLD}${CYAN}${HEART} Penélope:${NC} 'Ótimo trabalho!' ${CROWN}\n"
    elif [[ $health_percent -ge 50 ]]; then
        echo -e "${BOLD}${YELLOW}${WARNING} Maximus:${NC} 'Alguns serviços precisam de atenção.' ${HOURGLASS}"
        echo -e "${BOLD}${MAGENTA}${HEART} Penélope:${NC} 'Vamos dar uma olhada?' ${EYE}\n"
    else
        echo -e "${BOLD}${RED}${CROSS} Maximus:${NC} 'Precisamos de ajuda aqui!' ${WARNING}"
        echo -e "${BOLD}${YELLOW}${HEART} Penélope:${NC} 'Calma, vamos resolver isso juntos!' ${SPARKLES}\n"
    fi

    # Menu interativo
    show_status_menu "$unhealthy" "$running"
}

show_status_menu() {
    local unhealthy_count="$1"
    local running_count="$2"

    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}${YELLOW}O que deseja fazer?${NC}"
    echo ""

    # Opção START - só aparece se houver containers parados
    if [[ "$running_count" -eq 0 ]] || docker compose ps -a --format "{{.State}}" 2>/dev/null | grep -q "exited"; then
        echo -e "   ${BOLD}1)${NC} ${ROCKET} ${GREEN}Iniciar serviços${NC}"
        local has_start=true
    fi

    # Opção STOP - só aparece se houver containers rodando
    if [[ "$running_count" -gt 0 ]]; then
        if [[ "$has_start" == "true" ]]; then
            echo -e "   ${BOLD}2)${NC} ${HOURGLASS} ${YELLOW}Parar serviços${NC}"
            local stop_num=2
        else
            echo -e "   ${BOLD}1)${NC} ${HOURGLASS} ${YELLOW}Parar serviços${NC}"
            local stop_num=1
        fi
        local has_stop=true
    fi

    # Opção RESTART - só aparece se houver containers rodando
    if [[ "$running_count" -gt 0 ]]; then
        if [[ "$has_start" == "true" && "$has_stop" == "true" ]]; then
            echo -e "   ${BOLD}3)${NC} ${GEAR} ${BLUE}Reiniciar serviços${NC}"
            local restart_num=3
        elif [[ "$has_stop" == "true" ]]; then
            echo -e "   ${BOLD}2)${NC} ${GEAR} ${BLUE}Reiniciar serviços${NC}"
            local restart_num=2
        else
            echo -e "   ${BOLD}1)${NC} ${GEAR} ${BLUE}Reiniciar serviços${NC}"
            local restart_num=1
        fi
        local has_restart=true
    fi

    # Opção ERRORS - só aparece se houver containers unhealthy
    if [[ "$unhealthy_count" -gt 0 ]]; then
        local next_num=1
        [[ "$has_start" == "true" ]] && ((next_num++))
        [[ "$has_stop" == "true" ]] && ((next_num++))
        [[ "$has_restart" == "true" ]] && ((next_num++))
        echo -e "   ${BOLD}${next_num})${NC} ${EYE} Exibir erros detalhados ${DIM}(containers degraded)${NC}"
        local errors_num=$next_num
        local has_errors=true
    fi

    # Opção REFRESH
    local next_num=1
    [[ "$has_start" == "true" ]] && ((next_num++))
    [[ "$has_stop" == "true" ]] && ((next_num++))
    [[ "$has_restart" == "true" ]] && ((next_num++))
    [[ "$has_errors" == "true" ]] && ((next_num++))
    echo -e "   ${BOLD}${next_num})${NC} ${SPARKLES} Atualizar status"
    local refresh_num=$next_num

    # Opção SAIR
    ((next_num++))
    echo -e "   ${BOLD}${next_num})${NC} ${CHECK} Sair"
    local exit_num=$next_num

    echo ""
    echo -ne "${CYAN}Escolha uma opção [1-${exit_num}]:${NC} "

    read -r choice

    # Processar escolha
    if [[ "$choice" == "1" && "$has_start" == "true" ]]; then
        start_services
        echo -ne "\n${CYAN}Pressione ENTER para voltar ao status...${NC}"
        read -r
        show_status
    elif [[ "$choice" == "$stop_num" && "$has_stop" == "true" ]]; then
        stop_services
        echo -ne "\n${CYAN}Pressione ENTER para voltar ao status...${NC}"
        read -r
        show_status
    elif [[ "$choice" == "$restart_num" && "$has_restart" == "true" ]]; then
        restart_services
        echo -ne "\n${CYAN}Pressione ENTER para voltar ao status...${NC}"
        read -r
        show_status
    elif [[ "$choice" == "$errors_num" && "$has_errors" == "true" ]]; then
        show_errors "$unhealthy_count"
    elif [[ "$choice" == "$refresh_num" ]]; then
        show_status
    elif [[ "$choice" == "$exit_num" ]]; then
        echo -e "\n${GREEN}${SPARKLES} Até logo!${NC}\n"
        exit 0
    else
        echo -e "\n${RED}${CROSS} Opção inválida!${NC}\n"
        sleep 1
        show_status
    fi
}

show_errors() {
    local unhealthy_count="$1"
    
    clear
    print_header
    print_section "DIAGNÓSTICO DE ERROS" "$WARNING"
    
    if [[ "$unhealthy_count" -eq 0 ]]; then
        echo -e "${GREEN}${CHECK} Nenhum erro detectado! Sistema saudável.${NC}\n"
        echo -ne "${CYAN}Pressione ENTER para voltar...${NC}"
        read -r
        show_status
        return
    fi
    
    echo -e "${BOLD}${RED}Containers com problemas:${NC}\n"
    
    cd "$PROJECT_ROOT"
    
    # Lista todos os containers e seus status
    docker compose ps --format "table {{.Service}}\t{{.State}}\t{{.Health}}" | while read -r line; do
        if [[ "$line" =~ unhealthy ]]; then
            local service=$(echo "$line" | awk '{print $1}')
            echo -e "${RED}${CROSS} ${BOLD}$service${NC}"
            echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
            
            # Últimas 10 linhas de log com erro
            echo -e "${YELLOW}Últimos logs:${NC}"
            docker compose logs --tail=10 "$service" 2>&1 | grep -iE "error|exception|failed|fatal" | tail -5 || echo -e "${DIM}  (nenhum erro explícito nos logs recentes)${NC}"
            echo ""
        fi
    done
    
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "\n${BOLD}${MAGENTA}${HEART} Penélope:${NC} 'Veja os detalhes completos com: ${CYAN}maximus logs [service]${NC}'\n"
    
    echo -ne "${CYAN}Pressione ENTER para voltar ao menu...${NC}"
    read -r
    
    show_status
}

show_logs() {
    local service="${1:-api_gateway}"
    
    print_header
    print_section "LOGS: $service" "$EYE"
    
    echo -e "${BOLD}${CYAN}${CROWN} Penélope:${NC} 'Vamos ver o que o $service está dizendo...'\n"
    echo -e "${DIM}Pressione Ctrl+C para sair${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
    
    sleep 1
    cd "$PROJECT_ROOT"
    docker compose logs -f --tail=100 "$service"
}

quick_health() {
    print_header
    print_section "QUICK HEALTH CHECK" "$SHIELD"

    echo -e "${HOURGLASS} Verificando saúde do sistema...\n"

    cd "$PROJECT_ROOT"
    read -r total running healthy unhealthy <<< "$(get_service_stats)"

    echo -e "${BOLD}${CYAN}Métricas Rápidas:${NC}\n"
    echo -e "   ${PACKAGE} Total:     ${BOLD}$total${NC} containers definidos"
    echo -e "   ${ROCKET} Running:   ${BOLD}${GREEN}$running${NC} containers ativos"
    echo -e "   ${CHECK} Healthy:   ${BOLD}${GREEN}$healthy${NC} containers saudáveis"
    echo -e "   ${WARNING} Unhealthy: ${BOLD}${YELLOW}$unhealthy${NC} containers degradados"

    local health_percent=0
    if [[ $((healthy + unhealthy)) -gt 0 ]]; then
        health_percent=$((healthy * 100 / (healthy + unhealthy)))
    fi

    echo ""
    echo -e "   ${BRAIN} ${BOLD}Health Score: ${health_percent}%${NC}"

    # Verificar sidecars
    local sidecars=$(docker ps --filter "name=sidecar" --format "{{.Names}}" | wc -l || echo 0)
    echo -e "   ${STAR} Sidecars:  ${BOLD}${GREEN}$sidecars${NC} ativos"

    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if [[ $health_percent -ge 90 ]]; then
        echo -e "${BOLD}${GREEN}${CHECK} STATUS: EXCELENTE${NC} - Sistema operando perfeitamente!\n"
    elif [[ $health_percent -ge 70 ]]; then
        echo -e "${BOLD}${GREEN}${CHECK} STATUS: BOM${NC} - Sistema operacional, alguns serviços inicializando\n"
    elif [[ $health_percent -ge 50 ]]; then
        echo -e "${BOLD}${YELLOW}${WARNING} STATUS: ATENÇÃO${NC} - Alguns serviços com problemas\n"
    else
        echo -e "${BOLD}${RED}${CROSS} STATUS: CRÍTICO${NC} - Sistema necessita atenção imediata\n"
    fi

    echo -e "${DIM}Use ${CYAN}maximus status${DIM} para ver detalhes completos${NC}\n"
}

validate_pagani() {
    print_header
    print_section "VALIDAÇÃO PADRÃO PAGANI" "$SHIELD"

    echo -e "${BOLD}${CYAN}${CROWN} Penélope:${NC} 'Vamos validar a conformidade Pagani!' ${SPARKLES}\n"

    cd "$PROJECT_ROOT"

    if [[ -f "$PROJECT_ROOT/validate_pagani_standard.sh" ]]; then
        echo -e "${HOURGLASS} Executando validador Pagani...\n"
        bash "$PROJECT_ROOT/validate_pagani_standard.sh"
    else
        echo -e "${YELLOW}${WARNING} Script validate_pagani_standard.sh não encontrado${NC}\n"
        echo -e "${BOLD}Validação manual:${NC}\n"

        # Validação básica
        echo -e "   ${CHECK} Verificando TODOs em produção..."
        local todos=$(find backend/services -name "*.py" -not -path "*/tests/*" -exec grep -l "TODO" {} \; 2>/dev/null | wc -l)
        if [[ $todos -eq 0 ]]; then
            echo -e "      ${GREEN}✅ PASS${NC} - Zero TODOs em produção\n"
        else
            echo -e "      ${RED}❌ FAIL${NC} - Encontrados $todos arquivos com TODOs\n"
        fi

        echo -e "   ${CHECK} Verificando estrutura de serviços..."
        local services=$(find backend/services -maxdepth 1 -type d | wc -l)
        echo -e "      ${GREEN}✅ INFO${NC} - $services serviços encontrados\n"

        echo -e "   ${CHECK} Verificando docker-compose.yml..."
        if [[ -f docker-compose.yml ]]; then
            echo -e "      ${GREEN}✅ PASS${NC} - docker-compose.yml presente\n"
        else
            echo -e "      ${RED}❌ FAIL${NC} - docker-compose.yml não encontrado\n"
        fi
    fi
}

cleanup_system() {
    print_header
    print_section "LIMPEZA DO SISTEMA" "$GEAR"

    echo -e "${BOLD}${YELLOW}${WARNING} Atenção:${NC} Esta operação irá remover containers órfãos e volumes não utilizados\n"
    echo -ne "${CYAN}Deseja continuar? [s/N]:${NC} "
    read -r confirm

    if [[ ! "$confirm" =~ ^[sS]$ ]]; then
        echo -e "\n${YELLOW}${CROSS} Operação cancelada${NC}\n"
        return
    fi

    cd "$PROJECT_ROOT"

    echo -e "\n${HOURGLASS} Removendo containers órfãos...\n"
    docker compose down --remove-orphans

    echo -e "\n${HOURGLASS} Removendo volumes não utilizados...\n"
    docker volume prune -f

    echo -e "\n${HOURGLASS} Removendo imagens não utilizadas...\n"
    docker image prune -f

    echo -e "\n${GREEN}${CHECK} Limpeza concluída!${NC}\n"
    echo -e "${BOLD}${MAGENTA}${HEART} Penélope:${NC} 'Sistema limpo e organizado!' ${SPARKLES}\n"
}

show_help() {
    print_header

    echo -e "${BOLD}${CYAN}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓${NC}"
    echo -e "${BOLD}${CYAN}┃${NC} ${GEAR} ${BOLD}COMANDOS DISPONÍVEIS${NC}"
    echo -e "${BOLD}${CYAN}┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛${NC}"
    echo ""
    echo -e "   ${GREEN}${ROCKET} maximus start${NC}              ${DIM}Inicia todos os serviços em camadas${NC}"
    echo -e "   ${YELLOW}${HOURGLASS} maximus stop${NC}               ${DIM}Para todos os serviços${NC}"
    echo -e "   ${BLUE}${GEAR} maximus restart${NC}            ${DIM}Reinicia o sistema completo${NC}"
    echo -e "   ${CYAN}${BRAIN} maximus status${NC}             ${DIM}Dashboard de status detalhado${NC}"
    echo -e "   ${SHIELD} maximus health${NC}             ${DIM}Quick health check${NC}"
    echo -e "   ${SHIELD} maximus validate${NC}           ${DIM}Validar conformidade Pagani${NC}"
    echo -e "   ${GEAR} maximus cleanup${NC}            ${DIM}Limpar containers e volumes órfãos${NC}"
    echo -e "   ${MAGENTA}${EYE} maximus logs [service]${NC}    ${DIM}Mostra logs em tempo real${NC}"
    echo -e "   ${NC}${SPARKLES} maximus help${NC}               ${DIM}Mostra esta ajuda${NC}"
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${BOLD}${YELLOW}Exemplos:${NC}"
    echo -e "   ${GREEN}maximus start${NC}                      ${DIM}# Inicia o sistema completo em 4 camadas${NC}"
    echo -e "   ${CYAN}maximus status${NC}                     ${DIM}# Ver dashboard de status completo${NC}"
    echo -e "   ${SHIELD}maximus health${NC}                     ${DIM}# Quick health check (rápido)${NC}"
    echo -e "   ${SHIELD}maximus validate${NC}                   ${DIM}# Validar padrão Pagani${NC}"
    echo -e "   ${MAGENTA}maximus logs api_gateway${NC}          ${DIM}# Ver logs do API Gateway${NC}"
    echo -e "   ${BLUE}maximus restart${NC}                    ${DIM}# Reiniciar tudo${NC}"
    echo -e "   ${GEAR}maximus cleanup${NC}                    ${DIM}# Limpar sistema${NC}"
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${BOLD}${MAGENTA}${CROWN} Maximus & Penélope:${NC} 'Juntos, somos imbatíveis!' ${HEART}${SPARKLES}\n"
}

main() {
    case "${1:-status}" in
        start)
            start_services
            ;;
        stop)
            stop_services
            ;;
        restart)
            restart_services
            ;;
        status)
            show_status
            ;;
        health)
            quick_health
            ;;
        validate)
            validate_pagani
            ;;
        cleanup)
            cleanup_system
            ;;
        logs)
            show_logs "${2:-api_gateway}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}${CROSS} Comando desconhecido: $1${NC}\n"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
